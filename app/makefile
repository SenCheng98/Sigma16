# makefile for Sigma16

# Provide version number in generated html documentation

VERSION := 3.0.17.1-test

#  make all               build everything from source
#  make doc               generate html from user guide markdown source
#  make dependencies      use npm to download Javascript dependencies
#  make clean             temp and backup files
#  make very-clean        also delete generated doc/html files
#  make archive-tarball   save a .tgz tarball in archive directory

# See README.txt for file and directory layout.  The ArchiveLocation
# is relative to Sigma16/src

ArchiveLocation := ../../../archive

#---------------------------------------------------------------------
# Calculate locations and times, don't need to edit these

# Generate filename for archive
PackagePath := $(shell pwd)
PackageName := Sigma16
DateTimeStamp := $(shell date +%Y-%m-%d-at-%H-%M)
BuildDate != date +%d\ %b\ %Y
TarballName := $(PackageName)-on-$(DateTimeStamp).tgz
FullCopyName := $(PackageName)-on-$(DateTimeStamp)


# It's necessary to make doc, but the rest is optional: you can just
# launch in browser over internet.  See index in top level directory.

.PHONY : all
all :
	make doc
	make dependencies
	make executable
	make release

# make show-parameters -- print calculated parameters
.PHONY : show-parameters
show-parameters :
	echo PackagePath = $(PackagePath)
	echo PackageName = $(PackageName)
	echo DateTimeStamp = $(DateTimeStamp)
	echo BuildDate = $(BuildDate)
	echo TarballName = $(TarballName)
	echo FullCopyName = $(FullCopyName)
	echo ArchiveLocation = $(ArchiveLocation)
	echo Sigma16Version = $(Sigma16Version)

#---------------------------------------------------------------------
# Generate documentation

# make doc -- generate the html documentation from markdown source
.PHONY : doc
doc :
	mkdir -p doc/html
	cp -r doc/src/figures doc/html
	cp doc/src/doc.css doc/html
	pandoc --standalone \
          --table-of-contents --toc-depth=3 \
          --variable=date:'$(VersionDate)' \
          --variable=css:doc.css \
          -o doc/html/index.html \
	  doc/src/index.md

# make npm -- download Javascript dependencies
.PHONY : dependencies
dependencies :
	npm install

.PHONY : run
run :
	npm start

.PHONY : executable
executable :
	npm run mkdist

.PHONY : release
release :
	mkdir -p ../release/$(VERSION)
	cp ../index.html ../release/$(VERSION)
	cp ../LICENSE.txt ../release/$(VERSION)
	cp ../README.md ../release/$(VERSION)
	cp ../VERSION ../release/$(VERSION)
	mkdir -p ../release/$(VERSION)/app
	cp makefile ../release/$(VERSION)/app
	cp *.js ../release/$(VERSION)/app
	cp *.json ../release/$(VERSION)/app
	cp *.html ../release/$(VERSION)/app
	cp *.css ../release/$(VERSION)/app
	cp -r datafiles ../release/$(VERSION)/app
	cp -r doc ../release/$(VERSION)/app
	cp -r programs ../release/$(VERSION)/app
	mv dist/*.exe ../release/$(VERSION)/Sigma16-$(VERSION)-win.exe

# There is a bug in Electron-builder: it gives a bad name to the exe
# file; for example it produces 'sigma16 3.0.1-7.2.exe' including the
# quote characters, and if a better name is specified using
# artifactName it fails to expand the variables.  So in building the
# release, the executable files are renamed as they are moved.

#---------------------------------------------------------------------
# Maintaining the directories

# make clean -- remove backup and object files, and temporary
# compilation files.  Leaves executable, documentation, and source in
# place.

.PHONY : clean
clean :
	find . \( -name '*~'  \
	  -o -name '*.bak' \) -delete

# make very-clean -- remove html documentation files generated by
# pandoc, leaving a minimal source directory

.PHONY : very-clean
very-clean :
	make clean
	rm -rf datafiles/doc

# make archive-tarball -- create a tgz file of the entire
# Sigma16-i.j.k directory and place it in the archive directory.  See
# README.txt for directory layout.
.PHONY : archive-tarball
archive-tarball :
	cd ../.. ; \
	  pwd ; \
	  tar -czf $(TarballName) $(PackageName) ; \
	  mv $(TarballName) $(ArchiveLocation)

# make archive-copy -- create a full copy of the entire Sigma16-i.j.k
# directory and place it in the archive directory.
.PHONY : archive-copy
archive-copy :
	cd ../..; \
	  pwd ; \
	  cp -rp $(PackagePath) $(ArchiveLocation)/$(FullCopyName)

# make list-archive -- list contents of the archive directory
.PHONY : list-archive
list-archive :
	ls -lctr $(ArchiveLocation)
